<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Audio FX Manager</title>
<style>
html, body {height:100%; margin:0; background:transparent; font-family:'Futura',sans-serif; color:white;}
#audioStatusBar {
  position: fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  z-index:9999; display:flex; align-items:center; gap:14px;
  background: rgba(255,255,255,0.1); border-radius:40px; padding:10px 20px;
  backdrop-filter: blur(16px) saturate(180%); border:1px solid rgba(255,255,255,0.15);
  box-shadow:0 0 20px rgba(255,255,255,0.1); transition:opacity 0.5s ease, transform 0.4s ease, background 0.3s ease;
  opacity:0.25; animation: float 4s ease-in-out infinite;
}
#audioStatusBar:hover {opacity:1;}
.speaker {position:relative; width:30px; height:30px; cursor:pointer; transition: transform 0.3s ease;}
.speaker:hover {transform: scale(1.1);}
.mute-line {position:absolute; left:-2px; top:14px; width:34px; height:2px; background:red; transform:rotate(45deg); box-shadow:0 0 8px red; opacity:0; transition:opacity 0.3s ease;}
.speaker.off .mute-line {opacity:1;}
.led {width:14px; height:14px; border-radius:50%; transition:background 0.3s, box-shadow 0.3s; box-shadow:0 0 8px rgba(0,0,0,0.6);}
.led.on {background:#00ff66; box-shadow:0 0 8px #00ff66, 0 0 18px #00ff66;}
.led.off {background:#ff3333; box-shadow:0 0 8px #ff3333, 0 0 18px #ff3333;}
#audioText {font-size:15px; letter-spacing:1px; text-shadow:0 0 8px rgba(255,255,255,0.3);}
#volumeControl {appearance:none; width:90px; height:6px; border-radius:6px; background:rgba(255,255,255,0.3); outline:none; opacity:0; pointer-events:none; transition:opacity 0.3s ease;}
#volumeControl::-webkit-slider-thumb {appearance:none; width:12px; height:12px; border-radius:50%; background:white; box-shadow:0 0 10px white; cursor:pointer;}
#audioStatusBar:hover #volumeControl {opacity:1; pointer-events:all;}
@keyframes float {0%,100%{transform:translate(-50%,-50%) translateY(0);} 50%{transform:translate(-50%,-50%) translateY(-3px);}}
</style>
</head>
<body>

<div id="audioStatusBar">
  <div class="speaker off" id="speakerIcon">
    <svg id="speakerSVG" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="30" height="30" fill="white">
      <path d="M3 10v4h4l5 5V5L7 10H3z"/>
      <path id="waves" d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03z"/>
    </svg>
    <div class="mute-line"></div>
  </div>
  <div class="led off" id="audioLed"></div>
  <span id="audioText">Off</span>
  <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.9">
</div>

<script>
(() => {
  // Lista de sonidos
  const SOUND_URLS = {
    menu: "https://aiquimista-agil.github.io/Website-Content/Header/Light-Switch.mp3",
    logo: "https://aiquimista-agil.github.io/Website-Content/Header/FX-Light.mp3",
    // Puedes añadir más sonidos aquí
  };

  let audioCtx = null;
  const bufferCache = {};
  let globalGainNode = null;

  const led = document.getElementById("audioLed");
  const text = document.getElementById("audioText");
  const speaker = document.getElementById("speakerIcon");
  const speakerSVG = document.getElementById("speakerSVG");
  const volumeControl = document.getElementById("volumeControl");

  function createAudioContext() {
    if (!audioCtx) {
      const Ctx = window.AudioContext || window.webkitAudioContext;
      audioCtx = new Ctx();
      globalGainNode = audioCtx.createGain();
      globalGainNode.gain.value = parseFloat(volumeControl.value);
      globalGainNode.connect(audioCtx.destination);
    }
    return audioCtx;
  }

  async function ensureAudioContext() {
    createAudioContext();
    if (audioCtx.state === 'suspended') {
      try { await audioCtx.resume(); } catch(e){ console.warn('resume failed', e); }
    }
  }

  async function loadBuffer(key) {
    if (bufferCache[key]) return bufferCache[key];
    const url = SOUND_URLS[key];
    if (!url) throw new Error('No URL for ' + key);
    const resp = await fetch(url, { cache: "no-store" });
    const arrayBuffer = await resp.arrayBuffer();
    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
    bufferCache[key] = audioBuffer;
    return audioBuffer;
  }

  async function playSound(key) {
    if (!isAudioEnabled()) return false;
    try {
      await ensureAudioContext();
      const buffer = await loadBuffer(key);
      const src = audioCtx.createBufferSource();
      src.buffer = buffer;
      src.connect(globalGainNode);
      src.start(0);
      src.onended = () => src.disconnect();
      return true;
    } catch(e) {
      console.warn('playSound err', e);
      return false;
    }
  }

  function setAudioEnabled(enabled) {
    localStorage.setItem("audioEnabled", enabled ? "1" : "0");
    updateAudioUI();
  }

  function isAudioEnabled() {
    return localStorage.getItem("audioEnabled") === "1";
  }

  function updateAudioUI() {
    const enabled = isAudioEnabled();
    if (enabled) {
      led.classList.remove("off"); led.classList.add("on");
      speaker.classList.remove("off");
      speakerSVG.setAttribute("fill", "white");
      text.textContent = "On";
    } else {
      led.classList.remove("on"); led.classList.add("off");
      speaker.classList.add("off");
      speakerSVG.setAttribute("fill", "#888");
      text.textContent = "Off";
    }
  }

  async function initialize() {
    createAudioContext();
    updateAudioUI();
    // precarga todos los buffers para que cualquier sonido se reproduzca inmediatamente
    await Promise.all(Object.keys(SOUND_URLS).map(k => loadBuffer(k).catch(()=>{})));
  }

  // Click en barra para alternar audio
  document.getElementById("audioStatusBar").addEventListener("click", async () => {
    const newState = !isAudioEnabled();
    setAudioEnabled(newState);
    await ensureAudioContext();
    // No reproducir un sonido específico, solo activa la reproducción
  });

  // Control de volumen
  volumeControl.addEventListener("input", () => {
    const vol = parseFloat(volumeControl.value);
    if (globalGainNode) globalGainNode.gain.value = vol;
    localStorage.setItem("volumeLevel", vol);
  });

  const savedVol = localStorage.getItem("volumeLevel");
  if (savedVol !== null) volumeControl.value = savedVol;

  initialize();

  // Exponer playSound para que eventos externos la puedan llamar
  window.playSound = playSound;
})();
</script>
</body>
</html>
