<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Audio FX Manager</title>

<!-- Fuente Cinzel Bold -->
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet">

<style>
  /* â€”â€”â€” Fondo general â€”â€”â€” */
  html, body {
    height: 100%;
    margin: 0;
    background: transparent;
    font-family: 'Cinzel', serif;
  }

  /* â€”â€”â€” Contenedor de botones â€”â€”â€” */
  .audio-controls {
    position: fixed;
    left: 10px;
    bottom: 10px;
    z-index: 9999;
    display: flex;
    gap: 18px;
    align-items: center;
  }

  /* â€”â€”â€” BotÃ³n base tipo pastilla â€”â€”â€” */
  .pill-btn {
    position: relative;
    min-width: 170px;
    height: 54px;
    border-radius: 999px;
    border: none;
    color: #fff;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1px;
    cursor: pointer;
    overflow: hidden;
    background-size: cover;
    background-position: center;
    text-shadow: 0 0 8px rgba(255,255,255,0.35);
    box-shadow: 0 0 24px rgba(0,0,0,0.4);
    transition: all 0.25s ease;
  }

  /* Brillo interior simulado con pseudo-elemento */
  .pill-btn::before {
    content: "";
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border-radius: inherit;
    background: radial-gradient(circle at 50% 20%, rgba(255,255,255,0.3) 0%, transparent 60%);
    opacity: 0.7;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .pill-btn:hover::before {
    opacity: 1;
  }

  /* â€”â€”â€” BotÃ³n rojo (Activar Audio) â€”â€”â€” */
  .btn-activate {
    background-image: url("https://aiquimista-agil.github.io/Website-Content/Alchemist-Assets/Images/Pastilla-Roja.png");
    box-shadow:
      0 0 25px rgba(255,40,80,0.5),
      0 0 60px rgba(255,60,120,0.3),
      inset 0 0 12px rgba(255,160,180,0.25);
  }

  .btn-activate:hover {
    transform: translateY(-2px) scale(1.03);
    box-shadow:
      0 0 35px rgba(255,40,80,0.7),
      0 0 85px rgba(255,80,120,0.45),
      inset 0 0 18px rgba(255,200,220,0.35);
    filter: brightness(1.08);
  }

  .btn-activate:active {
    transform: translateY(1px) scale(0.98);
    filter: brightness(0.9);
  }

  /* â€”â€”â€” BotÃ³n azul (Silencio) â€”â€”â€” */
  .btn-silence {
    background-image: url("https://aiquimista-agil.github.io/Website-Content/Alchemist-Assets/Images/Pastilla-Azul.png");
    box-shadow:
      0 0 25px rgba(60,150,255,0.5),
      0 0 60px rgba(0,120,255,0.3),
      inset 0 0 12px rgba(160,200,255,0.25);
  }

  .btn-silence:hover {
    transform: translateY(-2px) scale(1.03);
    box-shadow:
      0 0 35px rgba(90,170,255,0.7),
      0 0 85px rgba(0,160,255,0.45),
      inset 0 0 18px rgba(190,220,255,0.35);
    filter: brightness(1.08);
  }

  .btn-silence:active {
    transform: translateY(1px) scale(0.98);
    filter: brightness(0.9);
  }

  /* Efecto neÃ³n pulsante */
  @keyframes neonPulse {
    0%,100% { filter: brightness(1); }
    50% { filter: brightness(1.25); }
  }

  .btn-activate, .btn-silence {
    animation: neonPulse 4s ease-in-out infinite;
  }

  /* Oculto */
  .hidden { display: none !important; }

  @media (max-width:420px) {
    .pill-btn { min-width: 140px; height: 46px; font-size:13px; }
  }
</style>
</head>

<body>
  <div class="audio-controls">
    <button id="enableBtn" class="pill-btn btn-activate">Activar Audio</button>
    <button id="silenceBtn" class="pill-btn btn-silence">Silencio</button>
  </div>

<script>
/* ==========================================================
   ðŸŽ§ Audio FX Manager â€” funcionalidad sin cambios
   ----------------------------------------------------------
   Para agregar mÃ¡s sonidos, aÃ±ade nuevas entradas dentro de
   SOUND_URLS. Ejemplo:

   const SOUND_URLS = {
     menu: "url_del_sonido_menu.mp3",
     logo: "url_del_sonido_logo.mp3",
     click: "https://tu-servidor.com/sonidos/click.mp3",  // â† ejemplo nuevo
     ambient: "https://tu-servidor.com/sonidos/fondo.mp3" // â† ejemplo nuevo
   };

   Luego podrÃ¡s llamar desde postMessage:
   { type: 'play', sound: 'click' }
   ========================================================== */

(() => {
  const SOUND_URLS = {
    // ABOUT ME _______________________________________________________________________________________
    egypt: "https://aiquimista-agil.github.io/Website-Content/Alchemist-Assets/Sounds/Egypt.mp3",
    flames: "https://aiquimista-agil.github.io/Website-Content/Alchemist-Assets/Sounds/Fire-Sound.mp3",
    rain: "https://aiquimista-agil.github.io/Website-Content/Alchemist-Assets/Sounds/Rain-Sound.mp3",
    space: "https://aiquimista-agil.github.io/Website-Content/Alchemist-Assets/Sounds/Stars-Like-Dust.mp3",
    travel: "https://aiquimista-agil.github.io/Website-Content/Alchemist-Assets/Sounds/Close-To-Heaven.mp3",
    
    // FOOTER _________________________________________________________________________________________
    button: "https://aiquimista-agil.github.io/Website-Content/Alchemist-Assets/Sounds/Click-Button.mp3",
    phoenix: "https://aiquimista-agil.github.io/Website-Content/Alchemist-Assets/Sounds/Phoenix-Cry.mp3",
    submachine: "https://aiquimista-agil.github.io/Website-Content/Alchemist-Assets/Sounds/Submachine-Sound.mp3",
    
    // HEADER _________________________________________________________________________________________
    menu: "https://aiquimista-agil.github.io/Website-Content/Alchemist-Assets/Sounds/Light-Switch.mp3",
    logo: "https://aiquimista-agil.github.io/Website-Content/Alchemist-Assets/Sounds/FX-Light.mp3"
    // Puedes agregar mÃ¡s sonidos aquÃ­:
    // "click": "https://tu-servidor.com/sonidos/click.mp3",
    // "ambient": "https://tu-servidor.com/sonidos/ambiente.mp3"
  };

  let audioCtx = null;
  const bufferCache = {};
  let SILENCED = false;
  const INACTIVITY_MS = 33000;
  let inactivityTimer = null;

  const essentialSounds = ['menu','logo','button'];
  const ambientSounds = ['egypt','flames','rain','space','travel','phoenix','submachine'];

  // ðŸ”¸ Mapa de sonidos activos
  const activeSources = new Map();

  function startInactivityTimer() {
    clearInactivityTimer();
    inactivityTimer = setTimeout(() => {
      SILENCED = true;
      document.querySelector('.audio-controls')?.classList.add('hidden');
      stopAllSounds();
    }, INACTIVITY_MS);
  }

  function clearInactivityTimer() {
    if (inactivityTimer) {
      clearTimeout(inactivityTimer);
      inactivityTimer = null;
    }
  }

  async function ensureAudioContext() {
    if (!audioCtx) {
      const Ctx = window.AudioContext || window.webkitAudioContext;
      audioCtx = new Ctx();
    }
    if (audioCtx.state === 'suspended') await audioCtx.resume().catch(()=>{});
  }

  function fetchArrayBufferWithTimeout(url, ms = 20000) {
    return new Promise((resolve, reject) => {
      const timer = setTimeout(()=>reject(new Error('fetch-timeout')), ms);
      fetch(url, {cache: 'no-store'})
        .then(r => {
          clearTimeout(timer);
          if (!r.ok) return reject(new Error('fetch-failed'));
          return r.arrayBuffer();
        })
        .then(ab => resolve(ab))
        .catch(err => { clearTimeout(timer); reject(err); });
    });
  }

  async function loadBuffer(key) {
    if (SILENCED) throw new Error('silenced');
    if (bufferCache[key]) return bufferCache[key];
    const url = SOUND_URLS[key];
    const ab = await fetchArrayBufferWithTimeout(url, 25000);
    await ensureAudioContext();
    const buf = await audioCtx.decodeAudioData(ab.slice(0));
    bufferCache[key] = buf;
    return buf;
  }

  // ðŸ”Š Reproducir sonido Ãºnico
  async function playSound(key, options={}) {
    try {
      if (SILENCED) return;
      await ensureAudioContext();
      const buffer = await loadBuffer(key);
      const src = audioCtx.createBufferSource();
      const gain = audioCtx.createGain();
      gain.gain.value = options.volume ?? 0.9;
      src.buffer = buffer;
      src.connect(gain);
      gain.connect(audioCtx.destination);
      src.start(0);
      src.onended = ()=>{ try{src.disconnect();gain.disconnect();}catch(e){} };
    } catch(e){ console.warn('playSound', e); }
  }

  // ðŸ” Reproducir en loop y guardar referencia
  async function startLoop(key, options={}) {
    try {
      if (SILENCED) return;
      await ensureAudioContext();
      stopSound(key); // detener si ya estÃ¡ sonando
      const buffer = await loadBuffer(key);
      const src = audioCtx.createBufferSource();
      const gain = audioCtx.createGain();
      gain.gain.value = options.volume ?? 0.9;
      src.buffer = buffer;
      src.loop = true;
      src.connect(gain);
      gain.connect(audioCtx.destination);
      src.start(0);
      activeSources.set(key, {src, gain});
    } catch(e){ console.warn('startLoop', e); }
  }

  // â›” Detener sonido especÃ­fico
  function stopSound(key) {
    const entry = activeSources.get(key);
    if (entry) {
      try {
        entry.src.stop(0);
        entry.src.disconnect();
        entry.gain.disconnect();
      } catch(e){}
      activeSources.delete(key);
    }
  }

  // ðŸš« Detener todos los sonidos activos
  function stopAllSounds() {
    for (const key of activeSources.keys()) stopSound(key);
  }

  // Carga en background
  function scheduleBackgroundLoad(keys) {
    const runner = () => {
      for (const k of keys) loadBuffer(k).catch(()=>{});
    };
    if ('requestIdleCallback' in window) {
      requestIdleCallback(runner, {timeout: 30000});
    } else {
      setTimeout(runner, 1500);
    }
  }

  // ðŸ“© Escuchar mensajes desde Wix
  window.addEventListener('message', e=>{
    let d;
    try { d = (typeof e.data === 'string') ? JSON.parse(e.data) : e.data; } catch(_) { return; }
    if (!d || !d.type) return;

    switch (d.type) {
      case 'play':
        if (d.sound) playSound(d.sound, d.options||{});
        break;
      case 'startLoop':
        if (d.sound) startLoop(d.sound, d.options||{});
        break;
      case 'stop':
        if (d.sound) stopSound(d.sound);
        break;
      case 'stopAll':
        stopAllSounds();
        break;
      case 'resume':
        if (!SILENCED) {
          ensureAudioContext().then(()=>{
            Promise.all(essentialSounds.map(s=>loadBuffer(s).catch(()=>{})))
              .then(()=> scheduleBackgroundLoad(ambientSounds));
          }).catch(()=>{});
        }
        break;
    }
  });

  // ðŸŽšï¸ Botones
  const enableBtn = document.getElementById('enableBtn');
  enableBtn?.addEventListener('click', async ()=>{
    clearInactivityTimer();
    if (SILENCED) {
      document.querySelector('.audio-controls')?.classList.add('hidden');
      return;
    }
    await ensureAudioContext();
    await Promise.all(essentialSounds.map(s => loadBuffer(s).catch(()=>{})));
    document.querySelector('.audio-controls')?.classList.add('hidden');
    scheduleBackgroundLoad(ambientSounds);
  });

  const silenceBtn = document.getElementById('silenceBtn');
  silenceBtn?.addEventListener('click', ()=>{
    clearInactivityTimer();
    SILENCED = true;
    document.querySelector('.audio-controls')?.classList.add('hidden');
    stopAllSounds();
  });

  startInactivityTimer();
  const c = document.querySelector('.audio-controls');
  ['mousemove','mouseenter','focus','touchstart'].forEach(evt=>{
    c?.addEventListener(evt, ()=>{
      if (!SILENCED && !c.classList.contains('hidden')) startInactivityTimer();
    }, {passive:true});
  });
})();
</script>
</body>
</html>
